(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))r(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function n(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(i){if(i.ep)return;i.ep=!0;const s=n(i);fetch(i.href,s)}})();var k=1e-6,E=typeof Float32Array<"u"?Float32Array:Array;function V(){var t=new E(16);return E!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function H(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function _t(t,e,n){var r=n[0],i=n[1],s=n[2],a,o,d,f,c,h,g,m,v,w,A,M;return e===t?(t[12]=e[0]*r+e[4]*i+e[8]*s+e[12],t[13]=e[1]*r+e[5]*i+e[9]*s+e[13],t[14]=e[2]*r+e[6]*i+e[10]*s+e[14],t[15]=e[3]*r+e[7]*i+e[11]*s+e[15]):(a=e[0],o=e[1],d=e[2],f=e[3],c=e[4],h=e[5],g=e[6],m=e[7],v=e[8],w=e[9],A=e[10],M=e[11],t[0]=a,t[1]=o,t[2]=d,t[3]=f,t[4]=c,t[5]=h,t[6]=g,t[7]=m,t[8]=v,t[9]=w,t[10]=A,t[11]=M,t[12]=a*r+c*i+v*s+e[12],t[13]=o*r+h*i+w*s+e[13],t[14]=d*r+g*i+A*s+e[14],t[15]=f*r+m*i+M*s+e[15]),t}function Nt(t,e,n){var r=Math.sin(n),i=Math.cos(n),s=e[4],a=e[5],o=e[6],d=e[7],f=e[8],c=e[9],h=e[10],g=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=s*i+f*r,t[5]=a*i+c*r,t[6]=o*i+h*r,t[7]=d*i+g*r,t[8]=f*i-s*r,t[9]=c*i-a*r,t[10]=h*i-o*r,t[11]=g*i-d*r,t}function Vt(t,e,n){var r=Math.sin(n),i=Math.cos(n),s=e[0],a=e[1],o=e[2],d=e[3],f=e[8],c=e[9],h=e[10],g=e[11];return e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=s*i-f*r,t[1]=a*i-c*r,t[2]=o*i-h*r,t[3]=d*i-g*r,t[8]=s*r+f*i,t[9]=a*r+c*i,t[10]=o*r+h*i,t[11]=d*r+g*i,t}function qt(t,e,n,r,i){var s=1/Math.tan(e/2);if(t[0]=s/n,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=s,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,i!=null&&i!==1/0){var a=1/(r-i);t[10]=(i+r)*a,t[14]=2*i*r*a}else t[10]=-1,t[14]=-2*r;return t}var zt=qt;function kt(t,e,n,r){var i,s,a,o,d,f,c,h,g,m,v=e[0],w=e[1],A=e[2],M=r[0],B=r[1],z=r[2],R=n[0],b=n[1],L=n[2];return Math.abs(v-R)<k&&Math.abs(w-b)<k&&Math.abs(A-L)<k?H(t):(c=v-R,h=w-b,g=A-L,m=1/Math.sqrt(c*c+h*h+g*g),c*=m,h*=m,g*=m,i=B*g-z*h,s=z*c-M*g,a=M*h-B*c,m=Math.sqrt(i*i+s*s+a*a),m?(m=1/m,i*=m,s*=m,a*=m):(i=0,s=0,a=0),o=h*a-g*s,d=g*i-c*a,f=c*s-h*i,m=Math.sqrt(o*o+d*d+f*f),m?(m=1/m,o*=m,d*=m,f*=m):(o=0,d=0,f=0),t[0]=i,t[1]=o,t[2]=c,t[3]=0,t[4]=s,t[5]=d,t[6]=h,t[7]=0,t[8]=a,t[9]=f,t[10]=g,t[11]=0,t[12]=-(i*v+s*w+a*A),t[13]=-(o*v+d*w+f*A),t[14]=-(c*v+h*w+g*A),t[15]=1,t)}function U(){var t=new E(3);return E!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function lt(t){var e=new E(3);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function S(t){var e=t[0],n=t[1],r=t[2];return Math.sqrt(e*e+n*n+r*r)}function y(t,e,n){var r=new E(3);return r[0]=t,r[1]=e,r[2]=n,r}function j(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function dt(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t}function it(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t}function Ut(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t}function Yt(t,e){var n=e[0],r=e[1],i=e[2],s=n*n+r*r+i*i;return s>0&&(s=1/Math.sqrt(s)),t[0]=e[0]*s,t[1]=e[1]*s,t[2]=e[2]*s,t}(function(){var t=U();return function(e,n,r,i,s,a){var o,d;for(n||(n=3),r||(r=0),i?d=Math.min(i*n+r,e.length):d=e.length,o=r;o<d;o+=n)t[0]=e[o],t[1]=e[o+1],t[2]=e[o+2],s(t,t,a),e[o]=t[0],e[o+1]=t[1],e[o+2]=t[2];return e}})();class W{constructor(e,n=[0,0,0],r=6,i=.2){this.cameraMatrix=V(),this.pitch=0,this.yaw=0,W.current=this,this.name=e,this.position=lt(n),this.speed=r,this.sensitivity=i*.01,this.updateMatrix()}look(e,n){this.yaw+=e*this.sensitivity,this.pitch+=n*this.sensitivity,this.pitch<-1.5&&(this.pitch=-1.5),this.pitch>1.5&&(this.pitch=1.5)}updateMatrix(){H(this.cameraMatrix),_t(this.cameraMatrix,this.cameraMatrix,this.position),Vt(this.cameraMatrix,this.cameraMatrix,this.yaw),Nt(this.cameraMatrix,this.cameraMatrix,this.pitch)}updatePosition(e,n,r=1){const i=Math.sin(this.yaw),s=Math.cos(this.yaw),a=i*e[2],o=s*e[2],d=s*e[0],f=-i*e[0],c=y(d+a,e[1],f+o);S(c)>0&&(Yt(c,c),Ut(c,c,this.speed*r*n),dt(this.position,this.position,c))}}const $t=t=>{if(t===null)throw new Error("Canvas is null!");const e=t.getContext("webgl2");if(!e)throw new Error("Webgl2 not supported");return e.viewport(0,0,t.width,t.height),e},Ht=()=>{const t=document.querySelector("#render");if(t==null)throw new Error("Canvas is empty!");return t},x=Ht();x.width=x.clientWidth*window.devicePixelRatio;x.height=x.clientHeight*window.devicePixelRatio;const l=$t(x);l.viewport(0,0,x.width,x.height);const st=new W("Main",[0,0,-6],8,.2);class X{constructor(e,n){this.ID=l.createProgram();const r=this.compile(l.VERTEX_SHADER,e),i=this.compile(l.FRAGMENT_SHADER,n);this.cleanup(r,i)}compile(e,n){try{const r=l.createShader(e);if(r==null)throw new Error("The shader is empty!");return l.shaderSource(r,n),l.compileShader(r),r}catch(r){throw console.error(r),r}}cleanup(e,n){l.attachShader(this.ID,e),l.attachShader(this.ID,n),l.linkProgram(this.ID),l.detachShader(this.ID,e),l.detachShader(this.ID,n),l.deleteShader(e),l.deleteShader(n)}static async getShaderSource(e){try{const n=await fetch(`/assets/${e}`);if(!n.ok)throw new Error(`Error fetching shader: ${n.status}`);return await n.text()}catch(n){throw console.error(n),n}}useProgram(){l.useProgram(this.ID)}delete(){l.deleteProgram(this.ID)}}class jt{id;indices;constructor(e){this.id=l.createBuffer(),this.indices=e,l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,this.id),l.bufferData(l.ELEMENT_ARRAY_BUFFER,e,l.STATIC_DRAW)}Bind(){l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,this.id)}unbind(){l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,null)}delete(){l.deleteBuffer(this.id)}}class Wt{constructor(e){this.ID=l.createBuffer(),this.vertices=e,l.bindBuffer(l.ARRAY_BUFFER,this.ID),l.bufferData(l.ARRAY_BUFFER,e,l.STATIC_DRAW)}setAttributes(e){this.bind(),l.vertexAttribPointer(e.location,e.points,l.FLOAT,!1,e.stride,e.offset),l.enableVertexAttribArray(e.location),this.unbind()}bind(){l.bindBuffer(l.ARRAY_BUFFER,this.ID)}unbind(){l.bindBuffer(l.ARRAY_BUFFER,null)}delete(){l.deleteBuffer(this.ID)}}class Xt{constructor(e,n){this.EBO=null,this.ID=l.createVertexArray(),this.bind(),n&&(this.EBO=new jt(n)),this.VBO=new Wt(e)}bind(){l.bindVertexArray(this.ID)}unbind(){l.bindVertexArray(null)}setLocationAttributes(e){this.bind(),this.VBO.setAttributes(e),this.unbind()}delete(){this.VBO.delete(),l.deleteVertexArray(this.ID)}}const N=class N{constructor(e,n,r,i,s,a){this.shape=n,this.name=e,this.vertices=r,this.indices=i,this.shaderProgram=new X(s,a),this.VAO=new Xt(r,i),N.meshes.set(e,this)}SetLocation(e,n,r,i){this.VAO.setLocationAttributes({location:e,points:n,stride:r,offset:i})}Draw(){const{shaderProgram:e,VAO:n}=this;if(e.useProgram(),n.bind(),this.indices)l.drawElements(this.shape,this.indices.length,l.UNSIGNED_INT,0);else throw new Error("No indices")}delete(){this.shaderProgram.delete(),this.VAO.delete()}};N.meshes=new Map;let Y=N;async function Gt(t){const e=await t.arrayBuffer();return ft(e)}function ft(t){return Zt(t)?Kt(t):Jt(new TextDecoder().decode(t))}function Zt(t){return t.byteLength<84?!1:84+new DataView(t).getUint32(80,!0)*50===t.byteLength}function Kt(t){const e=new DataView(t),n=e.getUint32(80,!0),r=new Float32Array(n*9),i=new Uint32Array(n*3);let s=0,a=0,o=84;for(let d=0;d<n;d++){o+=12;for(let f=0;f<3;f++)r[s++]=e.getFloat32(o,!0),r[s++]=e.getFloat32(o+4,!0),r[s++]=e.getFloat32(o+8,!0),o+=12,i[a]=a,a++;o+=2}return{positions:r,indices:i}}function Jt(t){const e=/vertex\s+([+-]?(?:\d+\.?\d*|\.\d+)(?:[eE][+-]?\d+)?)\s+([+-]?(?:\d+\.?\d*|\.\d+)(?:[eE][+-]?\d+)?)\s+([+-]?(?:\d+\.?\d*|\.\d+)(?:[eE][+-]?\d+)?)/g,n=[];let r=null;for(;(r=e.exec(t))!==null;)n.push(Number(r[1]),Number(r[2]),Number(r[3]));if(n.length===0||n.length%9!==0)throw new Error("Invalid ASCII STL: no triangle vertices found.");const i=n.length/3,s=new Float32Array(n),a=new Uint32Array(i);for(let o=0;o<i;o++)a[o]=o;return{positions:s,indices:a}}const ht=V(),ut=V(),mt=V();H(mt);const P=document.querySelector("#stlFiles"),gt=document.querySelector("#loadDuck"),_=document.querySelector("#autoAlignToggle"),I=document.querySelector("#partSelect"),q=document.querySelector("#partColor"),pt=document.querySelector("#applyColor"),yt=document.querySelector("#rotateAxis"),vt=document.querySelector("#rotateDegrees"),xt=document.querySelector("#rotateMinus"),wt=document.querySelector("#rotatePlus"),At=document.querySelector("#mergeParts"),Mt=document.querySelector("#clearScene"),D=document.querySelector("#sceneStatus");if(!P||!gt||!_||!I||!q||!pt||!yt||!vt||!xt||!wt||!At||!Mt||!D)throw new Error("Viewer controls were not found in index.html.");l.clearColor(.05,.08,.12,1);l.enable(l.DEPTH_TEST);const Qt=await X.getShaderSource("vertex.vert"),te=await X.getShaderSource("fragment.frag"),u={parts:[],merged:null,modelOffset:null,autoAlign:_.checked,selectedPartId:""},It=y(0,0,0),p={target:y(0,0,0),distance:5,yaw:0,pitch:.2,minDistance:.25,maxDistance:500,dragging:!1,sensitivity:.006},ot=[[.86,.31,.25],[.17,.58,.76],[.2,.65,.35],[.95,.74,.2],[.65,.45,.9],[.9,.45,.7]];function G(t,e,n){const r=new Y(t,l.TRIANGLES,e,n,Qt,te);return r.SetLocation(0,3,24,0),r.SetLocation(1,3,24,12),r}function F(){const t=u.parts.length,e=u.merged?" | merged: yes":"",n=u.autoAlign?" | align: on":" | align: off";D.textContent=`parts: ${t}${e}${n}`}function St(t){const e=Math.round(Math.min(1,Math.max(0,t[0]))*255).toString(16).padStart(2,"0"),n=Math.round(Math.min(1,Math.max(0,t[1]))*255).toString(16).padStart(2,"0"),r=Math.round(Math.min(1,Math.max(0,t[2]))*255).toString(16).padStart(2,"0");return`#${e}${n}${r}`}function ee(t){const e=t.replace("#",""),n=e.length===6?e:"ffffff",r=parseInt(n.slice(0,2),16)/255,i=parseInt(n.slice(2,4),16)/255,s=parseInt(n.slice(4,6),16)/255;return[r,i,s]}function Pt(t,e){const n=new Float32Array(t.length/3*6);let r=0,i=0;for(;r<t.length;)n[i++]=t[r++],n[i++]=t[r++],n[i++]=t[r++],n[i++]=e[0],n[i++]=e[1],n[i++]=e[2];return n}function C(t,e){const n=new Float32Array(t.length);for(let r=0;r<t.length;r+=3)n[r]=t[r]+e[0],n[r+1]=t[r+1]+e[1],n[r+2]=t[r+2]+e[2];return n}function ne(t){if(t.length===0)return null;const e=y(1/0,1/0,1/0),n=y(-1/0,-1/0,-1/0);for(const r of t)for(let i=0;i<r.length;i+=6){const s=r[i],a=r[i+1],o=r[i+2];s<e[0]&&(e[0]=s),a<e[1]&&(e[1]=a),o<e[2]&&(e[2]=o),s>n[0]&&(n[0]=s),a>n[1]&&(n[1]=a),o>n[2]&&(n[2]=o)}return{min:e,max:n}}function T(t){if(t.length===0)return null;const e=y(1/0,1/0,1/0),n=y(-1/0,-1/0,-1/0);for(const r of t)for(let i=0;i<r.length;i+=3){const s=r[i],a=r[i+1],o=r[i+2];s<e[0]&&(e[0]=s),a<e[1]&&(e[1]=a),o<e[2]&&(e[2]=o),s>n[0]&&(n[0]=s),a>n[1]&&(n[1]=a),o>n[2]&&(n[2]=o)}return{min:e,max:n}}function at(t,e){if(t.length===0)return new Float32Array(0);let n=0;for(const a of t)n+=a.length/3;const r=Math.max(1,Math.floor(n/e)),i=[];let s=0;for(const a of t)for(let o=0;o<a.length;o+=3)s%r===0&&i.push(a[o],a[o+1],a[o+2]),s++;return new Float32Array(i)}function re(t){const e=y(0,0,0),n=t.length/3;if(n===0)return e;for(let r=0;r<t.length;r+=3)e[0]+=t[r],e[1]+=t[r+1],e[2]+=t[r+2];return e[0]/=n,e[1]/=n,e[2]/=n,e}function Et(t,e){const n=new Float32Array(t.length),r=new Float32Array(t.length/3);if(e.length===0)return{matches:n,distances:r};for(let i=0;i<t.length;i+=3){const s=t[i],a=t[i+1],o=t[i+2];let d=0,f=Number.POSITIVE_INFINITY;for(let c=0;c<e.length;c+=3){const h=s-e[c],g=a-e[c+1],m=o-e[c+2],v=h*h+g*g+m*m;v<f&&(f=v,d=c)}n[i]=e[d],n[i+1]=e[d+1],n[i+2]=e[d+2],r[i/3]=Math.sqrt(f)}return{matches:n,distances:r}}function ie(){return[1,0,0,0,1,0,0,0,1]}function $(t,e,n){const r=new Float32Array(t.length);for(let i=0;i<t.length;i+=3){const s=t[i]-n[0],a=t[i+1]-n[1],o=t[i+2]-n[2];r[i]=e[0]*s+e[1]*a+e[2]*o+n[0],r[i+1]=e[3]*s+e[4]*a+e[5]*o+n[1],r[i+2]=e[6]*s+e[7]*a+e[8]*o+n[2]}return r}function O(t){const e=Math.cos(t),n=Math.sin(t);return[e,-n,0,n,e,0,0,0,1]}function se(t){const e=Math.cos(t),n=Math.sin(t);return[1,0,0,0,e,-n,0,n,e]}function oe(t){const e=Math.cos(t),n=Math.sin(t);return[e,0,n,0,1,0,-n,0,e]}function ae(t,e){return t==="x"?se(e):t==="y"?oe(e):O(e)}function ce(t,e,n){const{distances:r}=Et(t,e),i=Array.from(r).sort((c,h)=>c-h),s=Math.max(6,Math.floor(i.length*.15));let a=0;for(let c=0;c<s;c++)a+=i[c];a/=s;let o=0;for(let c=0;c<r.length;c++)r[c]<n&&o++;const d=o/Math.max(1,r.length),f=d>.4?(d-.4)*8:0;return a+f}function le(t,e,n=12,r=.18){const i=y(0,0,0);if(t.length===0||e.length===0)return i;let s=t;for(let a=0;a<n;a++){const{matches:o,distances:d}=Et(s,e),f=Array.from({length:d.length},(g,m)=>m).sort((g,m)=>d[g]-d[m]),c=Math.max(12,Math.floor(f.length*r)),h=y(0,0,0);for(let g=0;g<c;g++){const m=f[g]*3;h[0]+=o[m]-s[m],h[1]+=o[m+1]-s[m+1],h[2]+=o[m+2]-s[m+2]}if(h[0]/=c,h[1]/=c,h[2]/=c,dt(i,i,h),s=C(t,i),S(h)<5e-4)break}return i}function Ft(t){t.mesh.delete(),t.vertices=Pt(t.positions,t.color),t.mesh=G(`part-${t.id}`,t.vertices,t.indices)}function de(){return u.parts.find(t=>t.id===u.selectedPartId)??null}function Bt(t){const e=de();if(!e)return;const n=Number(vt.value);if(!Number.isFinite(n)||n<=0)return;const r=yt.value,i=n*Math.PI/180*t,s=ae(r,i),a=re(e.positions);e.positions=$(e.positions,s,a),Ft(e);const o=T(u.parts.map(d=>d.positions));o&&K(o.min,o.max)}function Z(){const t=u.selectedPartId;I.innerHTML="";const e=document.createElement("option");e.value="",e.textContent="Select Part",I.appendChild(e);for(const r of u.parts){const i=document.createElement("option");i.value=r.id,i.textContent=r.name,I.appendChild(i)}u.parts.some(r=>r.id===t)?(I.value=t,u.selectedPartId=t):u.parts.length>0?(I.value=u.parts[0].id,u.selectedPartId=u.parts[0].id):(I.value="",u.selectedPartId="");const n=u.parts.find(r=>r.id===u.selectedPartId);n&&(q.value=St(n.color))}function K(t,e){const n=y((t[0]+e[0])*.5,(t[1]+e[1])*.5,(t[2]+e[2])*.5),r=y(e[0]-t[0],e[1]-t[1],e[2]-t[2]),i=Math.max(S(r)*.5,.5);j(p.target,n),p.distance=Math.min(Math.max(i*2.2,2),p.maxDistance)}function fe(t){if(t.length===0)return null;const e=y(1/0,1/0,1/0),n=y(-1/0,-1/0,-1/0);for(const r of t){const i=r.positions;for(let s=0;s<i.length;s+=3){const a=i[s],o=i[s+1],d=i[s+2];a<e[0]&&(e[0]=a),o<e[1]&&(e[1]=o),d<e[2]&&(e[2]=d),a>n[0]&&(n[0]=a),o>n[1]&&(n[1]=o),d>n[2]&&(n[2]=d)}}return{min:e,max:n}}async function he(t){const e=[];for(let n=0;n<t.length;n++){const r=t.item(n);if(!r||!r.name.toLowerCase().endsWith(".stl"))continue;const i=await Gt(r);e.push({fileName:r.name,positions:i.positions,indices:i.indices})}return e}async function ue(t){const e=[];for(const n of t){const r=await fetch(n);if(!r.ok)throw new Error(`Failed to load ${n}: ${r.status}`);const i=ft(await r.arrayBuffer());e.push({fileName:n.split("/").pop()??n,positions:i.positions,indices:i.indices})}return e}function bt(t){u.merged?.mesh.delete(),u.merged=null;const e=fe(t);if(!e){F();return}const n=y((e.min[0]+e.max[0])*.5,(e.min[1]+e.max[1])*.5,(e.min[2]+e.max[2])*.5),r=y(e.max[0]-e.min[0],e.max[1]-e.min[1],e.max[2]-e.min[2]);if(Math.max(S(r)*.5,.5),!u.modelOffset){const o=lt(It);u.modelOffset=U(),it(u.modelOffset,o,n)}const i=u.modelOffset;if(!i)return;let s=t.map(o=>({fileName:o.fileName,indices:o.indices,positions:C(o.positions,i)}));if(u.autoAlign){const o=u.parts.map(d=>d.positions);for(let d=0;d<s.length;d++){const f=s[d];if(o.length===0){o.push(f.positions);continue}const c=T([f.positions]),h=T(o);if(!c||!h){o.push(f.positions);continue}const g=y((c.min[0]+c.max[0])*.5,(c.min[1]+c.max[1])*.5,(c.min[2]+c.max[2])*.5),m=y((h.min[0]+h.max[0])*.5,(h.min[1]+h.max[1])*.5,(h.min[2]+h.max[2])*.5),v=y(c.max[0]-c.min[0],c.max[1]-c.min[1],c.max[2]-c.min[2]),w=y(h.max[0]-h.min[0],h.max[1]-h.min[1],h.max[2]-h.min[2]),A=Math.max(S(v)*.5,.5),M=Math.max(S(w)*.5,.5),B=U();if(it(B,g,m),S(B)>(A+M)*.75){const R=at([f.positions],700),b=at(o,1500),L=g,Rt=Math.max(M*.015,.2),Ct=[ie(),O(Math.PI/2),O(Math.PI),O(-Math.PI/2)];let J=Number.POSITIVE_INFINITY,Q=f.positions;for(const tt of Ct){const et=$(R,tt,L),nt=le(et,b,12,.18),Tt=C(et,nt),rt=ce(Tt,b,Rt);if(rt<J){J=rt;const Ot=$(f.positions,tt,L);Q=C(Ot,nt)}}f.positions=Q}o.push(f.positions)}}for(let o=0;o<s.length;o++){const d=ot[(u.parts.length+o)%ot.length],f=s[o].positions,c=Pt(f,d),h=`${Date.now()}-${o}-${Math.random().toString(36).slice(2,8)}`,g={id:h,name:s[o].fileName,positions:f,color:d,vertices:c,indices:s[o].indices,mesh:G(`part-${h}`,c,s[o].indices)};u.parts.push(g)}const a=T(u.parts.map(o=>o.positions));a&&K(a.min,a.max),Z(),F()}async function me(t){const e=await he(t);bt(e)}async function ge(){const t=["/head.stl","/Duck.stl_B_A_A.stl","/Duck.stl_B_A_B.stl","/Duck.stl_B_B_A.stl","/Duck.stl_B_B_B.stl"];Lt();const e=await ue(t);bt(e)}function pe(){if(u.parts.length<2)return;u.merged?.mesh.delete();let t=0,e=0;for(const f of u.parts)t+=f.vertices.length,e+=f.indices.length;const n=new Float32Array(t),r=new Uint32Array(e);let i=0,s=0,a=0;for(const f of u.parts){n.set(f.vertices,i);for(let c=0;c<f.indices.length;c++)r[s+c]=f.indices[c]+a;i+=f.vertices.length,s+=f.indices.length,a+=f.vertices.length/6,f.mesh.delete()}const o=G("merged-model",n,r);u.merged={name:"merged-model",vertices:n,indices:r,mesh:o},u.parts=[];const d=ne([n]);d&&K(d.min,d.max),Z(),F()}function Lt(){for(const t of u.parts)t.mesh.delete();u.parts=[],u.merged?.mesh.delete(),u.merged=null,u.modelOffset=null,j(p.target,It),p.distance=5,Z(),F()}P.addEventListener("change",async()=>{if(!(!P.files||P.files.length===0))try{await me(P.files),P.value=""}catch(t){console.error(t),D.textContent="failed to load STL"}});gt.addEventListener("click",async()=>{try{D.textContent="loading project duck...",await ge()}catch(t){console.error(t),D.textContent="failed to load project duck"}});At.addEventListener("click",()=>pe());Mt.addEventListener("click",()=>Lt());_.addEventListener("change",()=>{u.autoAlign=_.checked,F()});I.addEventListener("change",()=>{u.selectedPartId=I.value;const t=u.parts.find(e=>e.id===u.selectedPartId);t&&(q.value=St(t.color))});pt.addEventListener("click",()=>{const t=u.parts.find(e=>e.id===u.selectedPartId);t&&(t.color=ee(q.value),Ft(t))});xt.addEventListener("click",()=>Bt(-1));wt.addEventListener("click",()=>Bt(1));x.addEventListener("mousedown",t=>{t.button===0&&(p.dragging=!0)});document.addEventListener("mousemove",t=>{p.dragging&&(p.yaw-=t.movementX*p.sensitivity,p.pitch-=t.movementY*p.sensitivity,p.pitch<-1.5&&(p.pitch=-1.5),p.pitch>1.5&&(p.pitch=1.5))});document.addEventListener("mouseup",()=>{p.dragging=!1});x.addEventListener("mouseleave",()=>{p.dragging=!1});x.addEventListener("wheel",t=>{t.preventDefault();const e=1+t.deltaY*.001;p.distance=Math.min(Math.max(p.distance*e,p.minDistance),p.maxDistance)},{passive:!1});function ct(t){t.shaderProgram.useProgram();const e=t.shaderProgram.ID;l.uniformMatrix4fv(l.getUniformLocation(e,"view"),!1,ut),l.uniformMatrix4fv(l.getUniformLocation(e,"model"),!1,mt),l.uniformMatrix4fv(l.getUniformLocation(e,"proj"),!1,ht),t.Draw()}function Dt(t){zt(ht,Math.PI/4,x.width/x.height,.01,2e3);const e=Math.cos(p.pitch),n=y(p.target[0]+p.distance*Math.sin(p.yaw)*e,p.target[1]+p.distance*Math.sin(p.pitch),p.target[2]+p.distance*Math.cos(p.yaw)*e);if(j(st.position,n),kt(ut,st.position,p.target,[0,1,0]),l.clear(l.COLOR_BUFFER_BIT|l.DEPTH_BUFFER_BIT),u.merged)ct(u.merged.mesh);else for(const r of u.parts)ct(r.mesh);requestAnimationFrame(Dt)}F();requestAnimationFrame(Dt);
